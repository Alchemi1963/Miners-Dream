package com.lavaingot.minersdream.util;

import java.util.ArrayList;

import com.lavaingot.minersdream.init.ItemInit;
import com.lavaingot.minersdream.init.PotionInit;
import com.lavaingot.minersdream.objects.damagesources.CustomDamageSource;

import net.minecraft.enchantment.Enchantment;
import net.minecraft.entity.EntityLiving;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.inventory.EntityEquipmentSlot;
import net.minecraft.item.Item;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.potion.PotionEffect;
import net.minecraft.util.text.ITextComponent;
import net.minecraft.util.text.TextComponentString;
import net.minecraftforge.event.entity.living.LivingEvent.LivingUpdateEvent;
import net.minecraftforge.event.entity.player.PlayerDestroyItemEvent;
import net.minecraftforge.fml.common.Mod.EventBusSubscriber;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;
import net.minecraftforge.fml.common.gameevent.TickEvent.PlayerTickEvent;

@EventBusSubscriber
public class Events {
	
	public static Events instance;
	public static ArrayList<Item> specialItems = new ArrayList<Item>();
	
	public static final ArrayList<PotionEffect> EFFECTS = new ArrayList<PotionEffect>();
	public static PotionEffect RADIATION = new PotionEffect(PotionInit.RADIATION);
	
	public static void init() {
	
		specialItems.add(ItemInit.AXE_URANIUM);
		specialItems.add(ItemInit.BOOTS_URANIUM);
		specialItems.add(ItemInit.CHESTPLATE_URANIUM);
		specialItems.add(ItemInit.HELMET_URANIUM);
		specialItems.add(ItemInit.HOE_URANIUM);
		specialItems.add(ItemInit.LEGGINGS_URANIUM);
		specialItems.add(ItemInit.PICKAXE_URANIUM);
		specialItems.add(ItemInit.SHOVEL_URANIUM);
		specialItems.add(ItemInit.SWORD_URANIUM);
	
	}
	
	@SubscribeEvent
	public static void onItemDestroy(PlayerDestroyItemEvent event) {
		if (event.getOriginal().getUnlocalizedName().equals("item.pickaxe_uranium")) {
			NBTTagList ench = event.getOriginal().getEnchantmentTagList();
			ItemStack bismuth = new ItemStack(ItemInit.PICKAXE_BISMUTH);
			
			for (int i = 0; i < ench.tagCount();i++) {
				int id = ench.getCompoundTagAt(i).getInteger("id");
				int lvl = ench.getCompoundTagAt(i).getInteger("lvl");
				
				bismuth.addEnchantment(Enchantment.getEnchantmentByID(id), lvl);
			}
			event.getEntityPlayer().addItemStackToInventory(bismuth);
		}
	}
	
	@SubscribeEvent
	public static void onPlayerTick(PlayerTickEvent event) {
		
		EntityPlayer player = event.player;
		
		for (PotionEffect effect : EFFECTS) { effect.performEffect(player); }
		
		if (player.isPotionActive(PotionInit.RADIATION)) { System.out.println(RADIATION.getAmplifier()); }
		
		int amplifierBase = 0;
		
		for (ItemStack items : event.player.inventory.mainInventory) {
			if (specialItems.contains(items.getItem())) {
				if (!player.isPotionActive(PotionInit.RADIATION)) {
					amplifier += items.getCount();
				} else if (player.isPotionActive(PotionInit.RADIATION)) {
					
					int amplifier = RADIATION.getAmplifier();
					player.removeActivePotionEffect(PotionInit.RADIATION);
					RADIATION = new PotionEffect(PotionInit.RADIATION, 160, items.getCount() + amplifier);
					player.addPotionEffect(RADIATION);
				}
			}
		}		
		
		for (ItemStack items : player.getArmorInventoryList()) {
			if (specialItems.contains(items.getItem())) {
				if (!player.isPotionActive(PotionInit.RADIATION)) {
					 
					RADIATION = new PotionEffect(PotionInit.RADIATION, 160);
					player.addPotionEffect(RADIATION);
					
					if (items.getCount() > 1) {
						player.removeActivePotionEffect(PotionInit.RADIATION);
						RADIATION = new PotionEffect(PotionInit.RADIATION, 160, items.getCount());
						player.addPotionEffect(RADIATION);
					}
				} else if (player.isPotionActive(PotionInit.RADIATION)) {
					
					int amplifier = RADIATION.getAmplifier();
					player.removeActivePotionEffect(PotionInit.RADIATION);
					RADIATION = new PotionEffect(PotionInit.RADIATION, 160, items.getCount() + amplifier);
					player.addPotionEffect(RADIATION);
				}
			}
		}		
		
		if (player.getItemStackFromSlot(EntityEquipmentSlot.HEAD).getItem().equals(ItemInit.HELMET_URANIUM) && 
				player.getItemStackFromSlot(EntityEquipmentSlot.CHEST).getItem().equals(ItemInit.CHESTPLATE_URANIUM) && 
				player.getItemStackFromSlot(EntityEquipmentSlot.LEGS).getItem().equals(ItemInit.LEGGINGS_URANIUM) && 
				player.getItemStackFromSlot(EntityEquipmentSlot.FEET).getItem().equals(ItemInit.BOOTS_URANIUM) ) {
			if (!player.isGlowing()) {player.setGlowing(true);}
			
			if (!player.capabilities.allowFlying) { 
				if (!player.world.isRemote) {player.sendMessage(new TextComponentString("§2You have the ability to fly now!")); }
				player.capabilities.allowFlying = true;
				
			}
		}
		else {
			if (player.isGlowing()) {player.setGlowing(false);}
			
			if (player.capabilities.allowFlying) { 
				if (!player.world.isRemote) {player.sendMessage(new TextComponentString("§4You cannot fly anymore...")); }
				player.capabilities.allowFlying = false;
				
				if (player.world.getHeight((int)player.posX, (int)player.posZ) != player.posY) {player.attemptTeleport(player.posX, player.world.getHeight((int)player.posX, (int)player.posZ), player.posZ);}
				player.setVelocity(0D, -1D, 0D);
				
			}
		}
	}
	
	@SubscribeEvent
	public static void onEnitityUpdate(LivingUpdateEvent event) {
		if (event.getEntityLiving().isPotionActive(PotionInit.RADIATION) && event.getEntityLiving().world.rand.nextInt(1000) == 0) {
			event.getEntityLiving().hurtTime = 10;
			event.getEntityLiving().attackEntityFrom(CustomDamageSource.RADIATION, 1.0F);
		}
	}
}

